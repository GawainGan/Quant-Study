### 2 - Aggregate Performance Parameters

#### a. **Return**:
- Represents the average of the daily return for a given year.
- Formula:
  $$\text{Daily return} = \frac{\text{Today's close} - \text{Yesterday's close}}{\text{Yesterday's close}}$$

```python
daily_returns = [(historical_prices[i] - historical_prices[i-1]) / historical_prices[i-1] for i in range(1, len(historical_prices))]
average_daily_return = np.mean(daily_returns)
```

#### b. **PnL (Profit and Loss)**:
- Represents the profit or loss generated by a trading idea.
- Formula:
$$\text{Daily's pnl} = \sum (\text{position\} \times \text{daily's return})$$

```python
daily_pnl = [positions[i] * daily_returns[i] for i in range(len(daily_returns))]
total_pnl = sum(daily_pnl)
```

#### c. **IR (Information Ratio) or Sharpe Ratio**:
- Provides risk-adjusted returns.
- Formula:
  $$\text{IR} = \frac{\text{Mean(returns)}}{\text{std(returns)}}$$
  $$\text{Sharpe} = \text{IR} \times \sqrt{252}$$

```python
IR = np.mean(daily_pnl) / np.std(daily_pnl)
Sharpe = IR * np.sqrt(252)
```

#### d. **Turnover (tvr - 交易量)**:
- Represents the cost of trading.
- Formula:
  $$\text{Turnover} = \frac{\text{Value Traded}}{\text{Value Held}}$$

*Note: The exact computation of turnover can vary based on the trading strategy and the data available. The provided formula is a general representation.*

#### e. **Drawdown**:
- Represents the percentage of the largest loss incurred during a given period.
- Formula:
  $$\text{Drawdown} = \frac{\text{Peak value} - \text{Lowest value following the peak}}{\text{Peak value}}$$

```python
cumulative_pnl = np.cumsum(daily_pnl)
peak = np.maximum.accumulate(cumulative_pnl)
drawdown = (peak - cumulative_pnl) / peak
max_drawdown = np.max(drawdown)
return_to_drawdown_ratio = total_pnl / max_drawdown
```

---

### Key Takeaways:

1. **Return** gives an idea of the profitability of the strategy.
2. **PnL** provides a direct measure of the profit or loss generated.
3. **IR or Sharpe Ratio** offers a risk-adjusted measure of the strategy's performance.
4. **Turnover** indicates the cost associated with the strategy, with lower turnover being preferable.
5. **Drawdown** provides insight into the potential downside of the strategy, with a lower drawdown being preferable.

When evaluating a trading strategy or Alpha, it's essential to consider these aggregate performance parameters in conjunction to get a holistic view of the strategy's effectiveness and potential risks.

**Let's integrate the aggregate performance parameters into the code using the simulated data we did in Chapter 1**
### Case: 
This code will generate a plot of the simulated historical stock prices over 5 years, along with the 50-day moving average and Buy/Sell signals. It will also print the aggregate performance parameters for the strategy.
```python
import numpy as np
import matplotlib.pyplot as plt

# Setting a seed for reproducibility
np.random.seed(42)

# Parameters for the simulation
initial_price = 100  # Starting price of the stock
days = 1260  # 5 years of trading days
daily_returns = np.random.normal(0.0005, 0.02, days) + 1  # Mean daily return and volatility

# Generate simulated price data using random walk
historical_prices = [initial_price]
for i in range(1, days):
    price = historical_prices[-1] * daily_returns[i]
    historical_prices.append(price)

# Calculate daily returns
daily_returns = [(historical_prices[i] - historical_prices[i-1]) / historical_prices[i-1] for i in range(1, len(historical_prices))]

# Calculate 50-day moving average
LOOKBACK_DAYS = 50
moving_averages = [sum(historical_prices[i-LOOKBACK_DAYS:i]) / LOOKBACK_DAYS for i in range(LOOKBACK_DAYS, len(historical_prices))]

# Buy/Sell positions based on momentum strategy
positions = [1 if historical_prices[i] > moving_averages[i-LOOKBACK_DAYS] else -1 for i in range(LOOKBACK_DAYS, len(historical_prices))]

# Calculate daily PnL
daily_pnl = [positions[i] * daily_returns[i] for i in range(len(daily_returns) - LOOKBACK_DAYS)]

# Aggregate Performance Parameters
# 1. Return
average_daily_return = np.mean(daily_returns)

# 2. PnL
total_pnl = sum(daily_pnl)

# 3. IR (Information Ratio) or Sharpe Ratio
IR = np.mean(daily_pnl) / np.std(daily_pnl)
Sharpe = IR * np.sqrt(252)

# 4. Turnover (For simplicity, we'll use position changes as a proxy for turnover)
turnovers = np.diff(positions, prepend=positions[0])
turnover_rate = sum(abs(turnovers)) / len(turnovers)

# 5. Drawdown
cumulative_pnl = np.cumsum(daily_pnl)
peak = np.maximum.accumulate(cumulative_pnl)
drawdown = (peak - cumulative_pnl) / peak
max_drawdown = np.max(drawdown)
return_to_drawdown_ratio = total_pnl / max_drawdown

# Print the results
print(f"Average Daily Return: {average_daily_return:.2%}")
print(f"Total PnL: ${total_pnl:.2f}")
print(f"Information Ratio: {IR:.2f}")
print(f"Sharpe Ratio: {Sharpe:.2f}")
print(f"Turnover Rate: {turnover_rate:.2%}")
print(f"Max Drawdown: {max_drawdown:.2%}")
print(f"Return to Drawdown Ratio: {return_to_drawdown_ratio:.2f}")

# Plotting
plt.figure(figsize=(18,6))
plt.plot(historical_prices, label="Stock Price")
plt.plot(range(LOOKBACK_DAYS, len(historical_prices)), moving_averages, label="50-day Moving Average", color="orange")
plt.title("Simulated Historical Stock Prices Over 5 Years with Buy/Sell Signals")
plt.xlabel("Days")
plt.ylabel("Stock Price")
plt.grid(True)

# Annotate the buy/sell positions on the plot
for i, position in enumerate(positions[::30]):  # Taking every 30th position for annotation
    if position == 1:
        plt.annotate('Buy', (i*30+LOOKBACK_DAYS, historical_prices[i*30+LOOKBACK_DAYS]), color='g', fontsize=8)
    else:
        plt.annotate('Sell', (i*30+LOOKBACK_DAYS, historical_prices[i*30+LOOKBACK_DAYS]), color='r', fontsize=8)

plt.legend()
plt.show()
```
Output:
```
Average Daily Return: 0.13%
Total PnL: $0.89
Information Ratio: 0.04
Sharpe Ratio: 0.59
Turnover Rate: 15.70%
Max Drawdown: 3816.00%
Return to Drawdown Ratio: 0.02
```
![Chap2 - Simulated Historical Stock Prices Over 5 Years with Buy:Sell Signals](media/Chap2%20-%20Simulated%20Historical%20Stock%20Prices%20Over%205%20Years%20with%20Buy:Sell%20Signals.png)

Finally Let's evaluate the results:

1. **Average Daily Return**: 0.13%
   - This indicates that, on average, the strategy earns a return of 0.13% per day. This is a decent daily return, especially when compounded over many trading days.

2. **Total PnL**: $0.89
   - The strategy has generated a profit of $0.89 over the 5-year period. This might seem small, but the actual significance depends on the initial investment and the scale of trading.

3. **Information Ratio (IR)**: 0.04
   - The Information Ratio measures the risk-adjusted return of the strategy. An IR of 0.04 is relatively low. Typically, an IR above 0.5 is considered good. This suggests that the strategy might not be generating enough returns for the level of risk it's taking.

4. **Sharpe Ratio**: 0.59
   - The Sharpe Ratio annualizes the Information Ratio. A Sharpe Ratio above 1 is generally considered good. A value of 0.59 indicates that the strategy's risk-adjusted performance is below the desired level.

5. **Turnover Rate**: 15.70%
   - This indicates that the strategy changes its positions about 15.70% of the time. A lower turnover rate is generally preferred as it implies lower trading costs. This rate is decent, but there's room for improvement.

6. **Max Drawdown**: 3816.00%
   - This is an alarmingly high drawdown. It suggests that at some point, the strategy faced a significant loss from its peak value. Such a high drawdown is a major red flag and indicates that the strategy can experience severe losses.

7. **Return to Drawdown Ratio**: 0.02
   - This ratio indicates the return generated for every unit of drawdown risk taken. A higher ratio is preferred. A value of 0.02 is very low, suggesting that the strategy is not generating enough returns for the level of drawdown risk it's taking.

**Suggestions**:

1. **Risk Management**: Given the high drawdown, it's crucial to incorporate better risk management techniques. Consider setting stop-loss levels or diversifying the strategy across multiple assets or strategies.

2. **Refine Entry/Exit Criteria**: The current momentum-based criteria might benefit from additional filters or indicators to improve the signal quality.

3. **Optimize Lookback Period**: The 50-day moving average is just one possible lookback period. It might be beneficial to optimize this parameter or even consider using multiple moving averages.

4. **Incorporate Additional Indicators**: Consider adding other technical or fundamental indicators to the strategy to improve its predictive power.

5. **Regular Backtesting**: Continuously backtest the strategy with new data to ensure its continued relevance and effectiveness.

6. **Consider Costs**: Ensure that trading costs (like commissions and slippage) are considered in the strategy, as they can significantly impact net returns.

7. **Diversification**: Diversifying the strategy across multiple assets or even using a multi-strategy approach can help in reducing the drawdown and improving the overall risk-adjusted performance.

Remember, while backtesting provides valuable insights, it's essential to be cautious, as past performance is not always indicative of future results. Always test strategies with live data in a controlled environment before committing significant capital.
